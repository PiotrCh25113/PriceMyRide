name: Restart Azure Container App

on:
  push:
    branches: [ "main" ]
  

permissions:
  contents: read

jobs:
  restart-app:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Restart Cycle (Stop & Start)
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az extension add --name containerapp --upgrade --yes
            # --- Configuration ---
            APP_NAME="${{ vars.APP_NAME }}"
            RESOURCE_GROUP="${{ vars.RESOURCE_GROUP }}"
            # ---------------------

            echo "Stopping container app..."
            az containerapp stop --name $APP_NAME --resource-group $RESOURCE_GROUP
            
            # Loop to verify it's stopped
            echo "Waiting for status 'Stopped'..."
            while [ "$(az containerapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query properties.runningStatus -o tsv)" != "Stopped" ]; do
              sleep 5
              echo -n "."
            done
            echo ""
            echo "Container stopped."

            echo "Starting container app..."
            az containerapp start --name $APP_NAME --resource-group $RESOURCE_GROUP

            # Loop to verify it's running
            echo "Waiting for status 'Running'..."
            while [ "$(az containerapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query properties.runningStatus -o tsv)" != "Running" ]; do
              sleep 5
              echo -n "."
            done
            echo ""
            echo "Container is up and running!"
