name: Restart Azure Container App

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '.github/**'
      - '.gitignore'
  

permissions:
  contents: read

jobs:
  restart-app:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Restart Cycle (Stop & Start)
        uses: azure/CLI@v2
        with:
          inlineScript: |
            APP_NAME="${{ vars.APP_NAME }}"
            RESOURCE_GROUP="${{ vars.RESOURCE_GROUP }}"

            az config set extension.use_dynamic_install=yes_without_prompt
            az extension add --name containerapp --upgrade

            # Get the latest active revision name
            LATEST_REVISION=$(az containerapp revision list \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --query "[?properties.active==\`true\`].name | [0]" \
              --output tsv)

            if [ -z "$LATEST_REVISION" ]; then
              echo "Error: No active revision found for $APP_NAME"
              exit 1
            fi

            echo "Restarting revision: $LATEST_REVISION to pull latest image..."
            
            # Restart the specific revision
            az containerapp revision restart \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --revision "$LATEST_REVISION"

            echo "Restart command issued successfully."
