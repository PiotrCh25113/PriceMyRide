name: Restart Azure Container App

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '.github/**'
      - '.gitignore'
  

permissions:
  contents: read

jobs:
  restart-app:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Restart Cycle (Stop & Start)
        uses: azure/CLI@v2
        with:
          inlineScript: |
            # --- Configuration ---
            APP_NAME="${{ vars.APP_NAME }}"
            RESOURCE_GROUP="${{ vars.RESOURCE_GROUP }}"
            # ---------------------

            az extension add --name containerapp --upgrade

            echo "Getting App ID for '$APP_NAME'..."
            # distinct way to find the app that doesn't rely on the broken 'containerapp' command
            APP_ID=$(az resource show --resource-group "$RESOURCE_GROUP" --name "$APP_NAME" --resource-type "Microsoft.App/containerApps" --query id --output tsv)
            
            if [ -z "$APP_ID" ]; then
              echo "Error: Could not find Container App. Check your variables!"
              exit 1
            fi
            echo "Found App ID: $APP_ID"

            echo "Stopping container app..."
            az containerapp stop --name $APP_NAME --resource-group $RESOURCE_GROUP
            
            # Loop to verify it's stopped
            echo "Waiting for status 'Stopped'..."
            while [ "$(az containerapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query properties.runningStatus -o tsv)" != "Stopped" ]; do
              sleep 5
              echo -n "."
            done
            echo ""
            echo "Container stopped."

            echo "Starting container app..."
            az containerapp start --name $APP_NAME --resource-group $RESOURCE_GROUP

            # Loop to verify it's running
            echo "Waiting for status 'Running'..."
            while [ "$(az containerapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query properties.runningStatus -o tsv)" != "Running" ]; do
              sleep 5
              echo -n "."
            done
            echo ""
            echo "Container is up and running!"
